
Storing your LUKS key in TPM NVRAM

Fedora 17:

1. Install the tpm device driver, which is in the kernel-modules-extra package.
Load the module:
 # modprobe tpm_tis

2. Install tpm-luks, tpm-tools >= 1.3.8, trousers >= 0.3.9. Available at
   sf.net/projects/trousers. Start the tcsd:
 # tcsd

 You can test if trousers and tpm-tools are working ok by running tpm_nvinfo.
If it errors out with missing library errors, follow these steps:

 During the trousers build:
 $ ./configure --prefix=/usr
or
 After the trousers build:
 $ echo "/usr/local/lib" >> /etc/ld.so.conf
 # ldconfig

3. Determine your LUKS encrypted partions:
 $ blkid -t TYPE=crypto_LUKS
 /dev/sda2: UUID="4cb97e1f-b921-4f1a-bd86-032831b277af" TYPE="crypto_LUKS"

4. Add a new LUKS key to a key slot and the TPM:
# tpm_luks -c -d /dev/sda2
Enter a new TPM NV area password: 
Re-enter the new TPM NV area password: 
Enter your TPM owner password: 
Successfully wrote 33 bytes at offset 0 to NVRAM index 0x2 (2).
You will now be prompted to enter any valid LUKS passphrase in order to store
the new TPM NVRAM secret in LUKS key slot 1:

Enter any passphrase: 
Using NV index 2 for device /dev/sda2

5. Add code to query the TPM to the initramfs:
# dracut /boot/initramfs-3.4.4-5.fc17.x86_64-tpm-luks.img

6. Create a new boot entry that uses the new initramfs:
# vim /boot/grub2/grub.cfg

(The only change you need to make here is to copy the current boot entry
for Fedora and change the initramfs path to 
/boot/initramfs-3.4.4-5.fc17.x86_64-tpm-luks.img)

From https://fedoraproject.org/wiki/GRUB_2:
"It is safe to directly edit /boot/grub2/grub.cfg in Fedora."

7. Reboot

